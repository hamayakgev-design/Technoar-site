<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Technoar® Admin Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f5;
      --panel: #ffffff;
      --border: #e0e0e0;
      --text-main: #222;
      --text-muted: #777;
      --accent: #000;
      --radius-lg: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #000;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      font-size: 14px;
      margin: 0;
      font-weight: 500;
    }

    .btn, .btn-outline, .btn-ghost {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      background: #000;
      color: #fff;
    }

    .btn-outline {
      background: #fff;
      color: #222;
      border-color: #ddd;
    }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
      color: #555;
    }

    .btn:disabled,
    .btn-outline:disabled,
    .btn-ghost:disabled {
      opacity: 0.5;
      cursor: default;
    }

    main {
      flex: 1;
      display: flex;
      padding: 12px;
      gap: 12px;
    }

    @media (max-width: 840px) {
      main { flex-direction: column; }
    }

    .sidebar {
      width: 260px;
      max-width: 100%;
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar-block-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .sidebar-list {
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 220px;
      overflow: auto;
      background: #fafafa;
    }

    .sidebar-list-item {
      padding: 6px 8px;
      font-size: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      user-select: none;
    }
    .sidebar-list-item:last-child { border-bottom: none; }

    .sidebar-list-item.active {
      background: #000;
      color: #fff;
    }

    .sidebar-list-item:hover:not(.active) {
      background: #f0f0f0;
    }

    .main-panel {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .panel-topbar {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
    }

    .panel-topbar span { margin-right: 10px; }

    .main-panels-row {
      display: flex;
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .main-panels-row { flex-direction: column; }
    }

    .panel {
      flex: 1;
      min-width: 0;
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel h2 {
      font-size: 14px;
      margin: 0 0 6px;
    }

    #previewRoot {
      font-size: 13px;
      overflow: auto;
    }

    .preview-section {
      margin-bottom: 18px;
    }

    .preview-section h3 {
      font-size: 13px;
      margin: 0 0 4px;
    }

    .preview-products {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .preview-card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
      display: flex;
      gap: 10px;
      cursor: pointer;
      transition: background 0.1s ease;
    }

    .preview-card:hover {
      background: #f0f0f0;
    }

    .preview-card img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 6px;
      background: #fff;
      border: 1px solid #eee;
      flex-shrink: 0;
    }

    .preview-card h3 {
      font-size: 13px;
      margin: 0 0 2px;
    }

    .preview-card div {
      font-size: 12px;
      color: #555;
    }

    /* Right side: product editor */

    .editor {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
    }

    .editor-group {
      margin-bottom: 4px;
    }

    .editor-label {
      font-size: 11px;
      margin-bottom: 2px;
      color: #555;
    }

    .editor input[type="text"],
    .editor textarea {
      width: 100%;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      outline: none;
    }

    .editor textarea {
      min-height: 60px;
      resize: vertical;
    }

    .editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .editor-image-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .editor-image-preview {
      width: 96px;
      height: 96px;
      border-radius: 8px;
      border: 1px dashed #ccc;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }

    .editor-image-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .editor-image-hint {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.3;
    }

    #exportArea {
      flex: 1;
      width: 100%;
      resize: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px;
      background: #fafafa;
    }

    .export-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f0f0f0;
      font-size: 11px;
      color: #555;
      margin-right: 4px;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <h1>Technoar® Admin Pro</h1>
    <button class="btn-outline" id="btnBackIndex">Back to index</button>
  </header>

  <main>
    <aside class="sidebar">
      <div>
        <div class="sidebar-block-title">Brands</div>
        <button class="btn" id="btnAddBrand">+ Add brand</button>
      </div>
      <div class="sidebar-list" id="brandList"></div>

      <div>
        <div class="sidebar-block-title">Sections of brand</div>
        <button class="btn" id="btnAddSection">+ Add section</button>
      </div>
      <div class="sidebar-list" id="sectionList"></div>
    </aside>

    <section class="main-panel">
      <div class="panel-topbar">
        <div>
          <span>Active brand:
            <strong id="activeBrandLabel">– none –</strong>
          </span>
          <span>Active section:
            <strong id="activeSectionLabel">– none –</strong>
          </span>
        </div>
        <div>
          <button class="btn" id="btnAddProduct">+ Add product</button>
        </div>
      </div>

      <div class="main-panels-row">
        <div class="panel">
          <h2>Preview</h2>
          <div id="previewRoot">
            <p style="font-size:12px;color:#777;">
              Select a brand &amp; section on the left, then add products.
            </p>
          </div>
        </div>

        <div class="panel">
          <h2>Product editor / export</h2>
          <div class="main-panels-row" style="gap:8px;flex:1;min-height:0;">
            <div class="panel" style="padding:8px;flex:1;min-width:0;">
              <div class="editor" id="editorRoot">
                <p style="font-size:12px;color:#777;">
                  Click on a product in the preview, or use
                  <strong>+ Add product</strong>.
                </p>
              </div>
            </div>

            <div class="panel" style="padding:8px;flex:1;min-width:0;">
              <div class="export-hint">
                When you're ready, click the button below to generate and download
                <code>catalog.json</code> (replace the file in your project).
              </div>
              <button class="btn" id="btnDownloadJson" style="margin-bottom:6px;">
                Generate &amp; download catalog.json
              </button>
              <textarea id="exportArea" spellcheck="false"></textarea>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // =========================
  // DATA MODEL
  // =========================
  let ADMIN_CATALOG = { brands: [] };

  const FALLBACK_CATALOG = {
    brands: [
      {
        id: "nobel",
        name: "Nobel® compatible",
        description: "Sample brand description (replace with real Technoar data).",
        sections: [
          {
            id: "multiunit",
            title: "Multiunit",
            products: [
              {
                id: "sample-prod-1",
                name: "Sample MU 17° – RP",
                imageUrl: "https://via.placeholder.com/300x180?text=Sample+MU+17%C2%B0",
                meta: "Height: 2 / 3 / 4mm",
                more: "Titanium Grade 5 · Hex",
                code: "TNA-SAMPLE-01"
              }
            ]
          }
        ]
      }
    ]
  };

  let activeBrandId = null;
  let activeSectionId = null;
  let activeProductId = null;

  // map productId → dataURL for session preview
  const LOCAL_PREVIEWS = {};

  // =========================
  // DOM REFS
  // =========================
  const brandListEl = document.getElementById("brandList");
  const sectionListEl = document.getElementById("sectionList");
  const activeBrandLabelEl = document.getElementById("activeBrandLabel");
  const activeSectionLabelEl = document.getElementById("activeSectionLabel");
  const previewRootEl = document.getElementById("previewRoot");
  const editorRootEl = document.getElementById("editorRoot");
  const exportAreaEl = document.getElementById("exportArea");

  const btnAddBrand = document.getElementById("btnAddBrand");
  const btnAddSection = document.getElementById("btnAddSection");
  const btnAddProduct = document.getElementById("btnAddProduct");
  const btnDownloadJson = document.getElementById("btnDownloadJson");
  const btnBackIndex = document.getElementById("btnBackIndex");

  // =========================
  // HELPERS
  // =========================
  function makeId(prefix) {
    return prefix + "_" + Math.random().toString(36).slice(2, 8);
  }

  function findBrand(id) {
    return (ADMIN_CATALOG.brands || []).find(b => b.id === id) || null;
  }

  function findSection(brand, secId) {
    if (!brand) return null;
    return (brand.sections || []).find(s => s.id === secId) || null;
  }

  function findProduct(section, prodId) {
    if (!section) return null;
    return (section.products || []).find(p => p.id === prodId) || null;
  }

  function escapeHtml(str) {
    if (str == null) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function escapeAttr(str) {
    return escapeHtml(str);
  }

  // =========================
  // SORT CATALOG (A→Z)
  // =========================
  function sortCatalog() {
    if (!ADMIN_CATALOG.brands) return;

    ADMIN_CATALOG.brands.forEach(brand => {
      if (brand.sections && brand.sections.length) {
        brand.sections.sort((a, b) => {
          const ta = (a.title || "").toLowerCase();
          const tb = (b.title || "").toLowerCase();
          if (ta < tb) return -1;
          if (ta > tb) return 1;
          return 0;
        });

        brand.sections.forEach(section => {
          if (section.products && section.products.length) {
            section.products.sort((p1, p2) => {
              const n1 = (p1.name || "").toLowerCase();
              const n2 = (p2.name || "").toLowerCase();
              if (n1 < n2) return -1;
              if (n1 > n2) return 1;
              return 0;
            });
          }
        });
      }
    });
  }

  // =========================
  // LOAD catalog.json
  // =========================
  function loadAdminCatalog() {
    return fetch("catalog.json")
      .then(res => res.json())
      .then(data => {
        ADMIN_CATALOG = data || { brands: [] };
      })
      .catch(() => {
        ADMIN_CATALOG = JSON.parse(JSON.stringify(FALLBACK_CATALOG));
      });
  }

  // =========================
  // RENDER – BRANDS
  // =========================
  function renderBrandListAdmin() {
    if (!brandListEl) return;

    let html = "";
    if (!ADMIN_CATALOG.brands.length) {
      html = '<div style="font-size:12px;color:#777;padding:6px;">No brands yet.</div>';
    } else {
      ADMIN_CATALOG.brands.forEach(brand => {
        const isActive = brand.id === activeBrandId;
        html +=
          '<div class="sidebar-list-item' +
          (isActive ? " active" : "") +
          '" data-brand-id="' +
          escapeAttr(brand.id || "") +
          '">' +
          escapeHtml(brand.name || "(no name)") +
          "</div>";
      });
    }
    brandListEl.innerHTML = html;

    brandListEl.querySelectorAll(".sidebar-list-item").forEach(item => {
      item.addEventListener("click", () => {
        const id = item.getAttribute("data-brand-id");
        if (!id) return;
        activeBrandId = id;
        activeSectionId = null;
        activeProductId = null;
        renderEverything();
      });
    });
  }

  // =========================
  // RENDER – SECTIONS
  // =========================
  function renderSectionListAdmin() {
    if (!sectionListEl) return;

    const brand = findBrand(activeBrandId);
    if (!brand) {
      sectionListEl.innerHTML =
        '<div style="font-size:12px;color:#777;padding:6px;">Select a brand first.</div>';
      return;
    }
    if (!brand.sections || !brand.sections.length) {
      sectionListEl.innerHTML =
        '<div style="font-size:12px;color:#777;padding:6px;">No sections yet.</div>';
      return;
    }

    let html = "";
    brand.sections.forEach(section => {
      const isActive = section.id === activeSectionId;
      html +=
        '<div class="sidebar-list-item' +
        (isActive ? " active" : "") +
        '" data-section-id="' +
        escapeAttr(section.id || "") +
        '">' +
        escapeHtml(section.title || "(no title)") +
        "</div>";
    });
    sectionListEl.innerHTML = html;

    sectionListEl.querySelectorAll(".sidebar-list-item").forEach(item => {
      item.addEventListener("click", () => {
        const secId = item.getAttribute("data-section-id");
        if (!secId) return;
        activeSectionId = secId;
        activeProductId = null;
        renderEverything();
      });
    });
  }

  // =========================
  // RENDER – LABELS
  // =========================
  function renderLabels() {
    const b = findBrand(activeBrandId);
    const s = b && findSection(b, activeSectionId);

    activeBrandLabelEl.textContent = b ? b.name || "" : "– none –";
    activeSectionLabelEl.textContent = s ? s.title || "" : "– none –";
  }

  // =========================
  // RENDER – PREVIEW
  // =========================
  function renderPreview() {
    if (!previewRootEl) return;

    const brand = findBrand(activeBrandId);
    if (!brand) {
      previewRootEl.innerHTML =
        '<p style="font-size:13px;color:#777;">Select a brand on the left, or create a new one.</p>';
      return;
    }

    let html = "";
    html += "<div>";
    html += "<h3>" + escapeHtml(brand.name || "") + "</h3>";
    if (brand.description) {
      html +=
        '<p style="font-size:12px;color:#555;margin-top:2px;">' +
        escapeHtml(brand.description) +
        "</p>";
    }

    if (!brand.sections || !brand.sections.length) {
      html +=
        '<p style="font-size:12px;color:#777;">No sections yet for this brand.</p>';
    } else {
      brand.sections.forEach(section => {
        html += '<div class="preview-section">';
        html +=
          '<h3 style="font-size:13px;margin-bottom:4px;">' +
          escapeHtml(section.title || "") +
          "</h3>";

        if (!section.products || !section.products.length) {
          html +=
            '<div style="font-size:12px;color:#999;">No products yet.</div>';
        } else {
          html += '<div class="preview-products">';
          section.products.forEach(p => {
            const isActive = p.id === activeProductId;
            const previewSrc =
              LOCAL_PREVIEWS[p.id] || p.imageUrl || "";

            html +=
              '<div class="preview-card" data-section-id="' +
              escapeAttr(section.id || "") +
              '" data-product-id="' +
              escapeAttr(p.id || "") +
              '">';

            if (previewSrc) {
              html +=
                '<img src="' +
                escapeAttr(previewSrc) +
                '" alt="' +
                escapeAttr(p.name || "") +
                '">';
            }

            html += '<div>';
            html +=
              "<h3>" +
              escapeHtml(p.name || "(no name)") +
              (isActive
                ? ' <span class="pill">editing</span>'
                : "") +
              "</h3>";
            if (p.meta) {
              html += "<div>" + escapeHtml(p.meta || "") + "</div>";
            }
            if (p.more) {
              html += "<div>" + escapeHtml(p.more || "") + "</div>";
            }
            if (p.code) {
              html +=
                '<div style="margin-top:4px;font-family:ui-monospace;font-size:11px;color:#999;">' +
                escapeHtml(p.code || "") +
                "</div>";
            }
            html += "</div>"; // text block

            html += "</div>"; // .preview-card
          });
          html += "</div>";
        }

        html += "</div>";
      });
    }

    html += "</div>";
    previewRootEl.innerHTML = html;

    previewRootEl.querySelectorAll(".preview-card").forEach(card => {
      card.addEventListener("click", () => {
        const secId = card.getAttribute("data-section-id");
        const prodId = card.getAttribute("data-product-id");
        activeSectionId = secId;
        activeProductId = prodId;
        renderEverything();
      });
    });
  }

  // =========================
  // RENDER – PRODUCT EDITOR
  // =========================
  function renderEditor() {
    if (!editorRootEl) return;

    const brand = findBrand(activeBrandId);
    const section = brand && findSection(brand, activeSectionId);
    const product =
      section && activeProductId
        ? findProduct(section, activeProductId)
        : null;

    if (!brand || !section) {
      editorRootEl.innerHTML =
        '<p style="font-size:12px;color:#777;">Select a brand and section, then click <strong>+ Add product</strong>.</p>';
      return;
    }

    // if no product selected → show "new product" helper
    if (!product) {
      editorRootEl.innerHTML =
        '<p style="font-size:12px;color:#777;">Click <strong>+ Add product</strong> to create a new item in this section.</p>';
      return;
    }

    const previewSrc = LOCAL_PREVIEWS[product.id] || product.imageUrl || "";
    const safeName = product.name || "";
    const imgPath = product.imageUrl || "";

    editorRootEl.innerHTML = `
      <div class="editor">
        <div class="editor-group">
          <div class="editor-label">Brand / section</div>
          <div class="pill">${escapeHtml(brand.name || "")}</div>
          <div class="pill">${escapeHtml(section.title || "")}</div>
        </div>

        <div class="editor-group">
          <div class="editor-label">Product name</div>
          <input type="text" id="edName" value="${escapeAttr(
            safeName
          )}" placeholder="e.g. MUA 17° – RP" />
        </div>

        <div class="editor-group">
          <div class="editor-label">Meta / short info</div>
          <input type="text" id="edMeta" value="${escapeAttr(
            product.meta || ""
          )}" placeholder="e.g. Height: 2 / 3 / 4mm" />
        </div>

        <div class="editor-group">
          <div class="editor-label">More / extra info</div>
          <textarea id="edMore" placeholder="Material, platform, notes...">${escapeHtml(
            product.more || ""
          )}</textarea>
        </div>

        <div class="editor-group">
          <div class="editor-label">Internal code</div>
          <input type="text" id="edCode" value="${escapeAttr(
            product.code || ""
          )}" placeholder="e.g. TNA-N-MUA17-RP-2" />
        </div>

        <div class="editor-group">
          <div class="editor-label">Image</div>
          <div class="editor-image-row">
            <div class="editor-image-preview" id="edImgPreview">
              ${
                previewSrc
                  ? `<img src="${escapeAttr(previewSrc)}" alt="${escapeAttr(
                      safeName
                    )}">`
                  : '<span style="font-size:11px;color:#aaa;">No image</span>'
              }
            </div>
            <div>
              <div class="editor-actions">
                <button class="btn-outline" id="btnChooseImage">Choose image</button>
                <button class="btn-ghost" id="btnClearImage"${
                  imgPath || previewSrc ? "" : " disabled"
                }>Remove</button>
              </div>
              <div class="editor-image-hint">
                Chosen image will be referenced as<br>
                <code>images/&lt;filename&gt;</code> in <code>catalog.json</code>.<br>
                Remember to copy the file into your <code>/images</code> folder.
                <br>
                Current path: <code>${escapeHtml(imgPath || "– none –")}</code>
              </div>
            </div>
          </div>
        </div>

        <div class="editor-group">
          <div class="editor-label">Actions</div>
          <div class="editor-actions">
            <button class="btn" id="btnSaveProduct">Save changes</button>
            <button class="btn-outline" id="btnDeleteProduct">Delete product</button>
          </div>
        </div>
      </div>
    `;

    // wire inputs
    const edName = document.getElementById("edName");
    const edMeta = document.getElementById("edMeta");
    const edMore = document.getElementById("edMore");
    const edCode = document.getElementById("edCode");
    const btnChooseImage = document.getElementById("btnChooseImage");
    const btnClearImage = document.getElementById("btnClearImage");
    const btnSaveProduct = document.getElementById("btnSaveProduct");
    const btnDeleteProduct = document.getElementById("btnDeleteProduct");

    function applyFormToProduct() {
      product.name = edName.value.trim();
      product.meta = edMeta.value.trim();
      product.more = edMore.value.trim();
      product.code = edCode.value.trim();
    }

    btnSaveProduct.addEventListener("click", () => {
      applyFormToProduct();
      renderEverything();
    });

    btnDeleteProduct.addEventListener("click", () => {
      const ok = window.confirm("Delete this product permanently?");
      if (!ok) return;
      section.products = (section.products || []).filter(
        p => p.id !== product.id
      );
      activeProductId = null;
      renderEverything();
    });

    btnClearImage.addEventListener("click", () => {
      product.imageUrl = "";
      delete LOCAL_PREVIEWS[product.id];
      renderEverything();
    });

    btnChooseImage.addEventListener("click", () => {
      openFilePickerForProduct(product);
    });
  }

  // =========================
  // IMAGE FILE PICKER + PREVIEW
  // =========================
  function openFilePickerForProduct(product) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";

    input.addEventListener("change", () => {
      const file = input.files && input.files[0];
      if (!file) return;

      const safeName = file.name.replace(/\s+/g, "_").toLowerCase();
      const relPath = "images/" + safeName;

      // store path in catalog
      product.imageUrl = relPath;

      // read as data URL for live preview
      const reader = new FileReader();
      reader.onload = e => {
        LOCAL_PREVIEWS[product.id] = e.target.result;
        renderEverything();
        window.alert(
          "Image selected: " +
            file.name +
            "\n\nIn catalog.json it will be saved as:\n" +
            relPath +
            "\n\nCopy this file into your /images folder with the same name."
        );
      };
      reader.readAsDataURL(file);
    });

    input.click();
  }

  // =========================
  // EXPORT
  // =========================
  function renderExport() {
    if (!exportAreaEl) return;
    const json = JSON.stringify(ADMIN_CATALOG, null, 2);
    exportAreaEl.value = json;
  }

  function downloadCatalogJson() {
    const json = JSON.stringify(ADMIN_CATALOG, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "catalog.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function renderEverything() {
    sortCatalog();
    renderBrandListAdmin();
    renderSectionListAdmin();
    renderLabels();
    renderPreview();
    renderEditor();
    renderExport();
  }

  // =========================
  // ADD BRAND / SECTION / PRODUCT
  // =========================
  function onAddBrand() {
    const name = window.prompt('Brand name (e.g. "Nobel® compatible")');
    if (!name) return;

    const id = makeId("brand");
    ADMIN_CATALOG.brands = ADMIN_CATALOG.brands || [];
    ADMIN_CATALOG.brands.push({
      id: id,
      name: name,
      description: "",
      sections: []
    });

    activeBrandId = id;
    activeSectionId = null;
    activeProductId = null;
    renderEverything();
  }

  function onAddSection() {
    const brand = findBrand(activeBrandId);
    if (!brand) {
      window.alert("Select a brand first.");
      return;
    }

    const title = window.prompt(
      'Section title (e.g. "Multiunit", "Ti base")'
    );
    if (!title) return;

    const id = makeId("section");
    brand.sections = brand.sections || [];
    brand.sections.push({
      id: id,
      title: title,
      products: []
    });

    activeSectionId = id;
    activeProductId = null;
    renderEverything();
  }

  function onAddProduct() {
    const brand = findBrand(activeBrandId);
    const section = brand && findSection(brand, activeSectionId);

    if (!brand) {
      window.alert("Select a brand first.");
      return;
    }
    if (!section) {
      window.alert("Select a section first.");
      return;
    }

    const id = makeId("prod");
    const newProduct = {
      id: id,
      name: "New product",
      imageUrl: "",
      meta: "",
      more: "",
      code: ""
    };

    section.products = section.products || [];
    section.products.push(newProduct);

    activeProductId = id;
    renderEverything();
  }

  // =========================
  // INIT
  // =========================
  (function initAdmin() {
    if (btnAddBrand) btnAddBrand.addEventListener("click", onAddBrand);
    if (btnAddSection) btnAddSection.addEventListener("click", onAddSection);
    if (btnAddProduct) btnAddProduct.addEventListener("click", onAddProduct);

    if (btnDownloadJson) {
      btnDownloadJson.addEventListener("click", () => {
        renderExport();
        downloadCatalogJson();
      });
    }

    if (btnBackIndex) {
      btnBackIndex.addEventListener("click", () => {
        window.location.href = "index.html";
      });
    }

    loadAdminCatalog().then(() => {
      if (ADMIN_CATALOG.brands && ADMIN_CATALOG.brands[0]) {
        activeBrandId = ADMIN_CATALOG.brands[0].id;
      }
      renderEverything();
    });
  })();
</script>
</body>
</html>
